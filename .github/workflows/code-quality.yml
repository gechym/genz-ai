name: Code Quality

on:
  push:
  pull_request:

jobs:
  # Job 1: Ruff - Format vÃ  Linting
  ruff-check:
    name: ğŸ¨ Ruff (Format & Lint)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10.6"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      id: setup-python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Install project
      run: poetry install --no-interaction
    
    - name: Validate Project Structure
      run: |
        echo "ğŸ” Validating project structure..."
        DIRS=""
        if [ -d "multi_agent" ]; then
          DIRS="$DIRS multi_agent/"
          echo "âœ… multi_agent/ found"
        else
          echo "âš ï¸  multi_agent/ not found"
        fi
        if [ -d "server" ]; then
          DIRS="$DIRS server/"
          echo "âœ… server/ found"
        else
          echo "âš ï¸  server/ not found"
        fi
        
        if [ -z "$DIRS" ]; then
          echo "âŒ No target directories found!"
          exit 1
        fi
        
        echo "TARGET_DIRS=$DIRS" >> $GITHUB_ENV
        echo "ğŸ“ Target directories: $DIRS"
    
    - name: ğŸ¨ Ruff Format Check (STRICT)
      run: |
        echo "ğŸ¨ Running Ruff Format Check - ZERO TOLERANCE..."
        if poetry run ruff check $TARGET_DIRS; then
          echo "âœ… RUFF FORMAT: PERFECT FORMATTING!"
        else
          echo "âŒ RUFF FORMAT: FAILED!"
          echo "ğŸ¯ REQUIREMENT: All code must be perfectly formatted"
          echo "ğŸ’¡ Fix command: poetry run ruff format $TARGET_DIRS"
          exit 1
        fi
    
    - name: ğŸ” Ruff Linting Check (STRICT)
      run: |
        echo "ğŸ” Running Ruff Linting - ZERO VIOLATIONS..."
        if poetry run ruff check $TARGET_DIRS --output-format=full; then
          echo "âœ… RUFF LINTING: NO VIOLATIONS FOUND!"
        else
          echo "âŒ RUFF LINTING: FAILED!"
          echo "ğŸ¯ REQUIREMENT: Zero linting violations allowed"
          echo "ğŸ’¡ Fix command: poetry run ruff check $TARGET_DIRS --fix"
          exit 1
        fi
    
    - name: Generate Ruff Reports
      if: always()
      run: |
        echo "ğŸ“„ Generating Ruff reports..."
        poetry run ruff check $TARGET_DIRS --output-format=json > ruff-report.json || true
        echo "Ruff reports generated"
    
    - name: Upload Ruff Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ruff-reports
        path: ruff-report.json

  # Job 2: Pylint - Code Quality Score
  pylint-check:
    name: ğŸ“Š Pylint (Score 10/10)
    runs-on: ubuntu-latest
    needs: ruff-check  # Chá»‰ cháº¡y khi Ruff pass
    strategy:
      matrix:
        python-version: ["3.10.6"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      id: setup-python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Install project
      run: poetry install --no-interaction
    
    - name: Set Target Directories
      run: |
        DIRS=""
        if [ -d "multi_agent" ]; then
          DIRS="$DIRS multi_agent/"
        fi
        if [ -d "server" ]; then
          DIRS="$DIRS server/"
        fi
        echo "TARGET_DIRS=$DIRS" >> $GITHUB_ENV
    
    - name: ğŸ“Š Pylint Score Check (STRICT 10/10)
      run: |
        echo "ğŸ“Š Running Pylint - PERFECT SCORE REQUIRED..."
        poetry run pylint $TARGET_DIRS --output-format=text | tee pylint-output.txt
        
        SCORE=$(grep "Your code has been rated at" pylint-output.txt | sed 's/.*rated at \([0-9.]*\).*/\1/' || echo "0")
        echo "ğŸ“Š Current Score: $SCORE/10"
        
        IS_PERFECT=$(python3 -c "import sys; score = float('$SCORE' if '$SCORE' else '0'); print('1' if score == 10.0 else '0')")
        
        if [ "$IS_PERFECT" = "1" ]; then
          echo "âœ… PYLINT: PERFECT SCORE ACHIEVED! ğŸ†"
          echo "ğŸ‰ Code quality is flawless!"
        else
          echo "âŒ PYLINT: FAILED! Score $SCORE/10 is not perfect!"
          echo "ğŸ¯ REQUIREMENT: Must achieve exactly 10.00/10"
          echo "ğŸ“‹ Please fix all pylint issues before proceeding"
          echo ""
          echo "ğŸ’¡ Common fixes needed:"
          echo "   - Add missing newlines at end of files"
          echo "   - Fix import order and formatting"  
          echo "   - Add missing docstrings"
          echo "   - Follow naming conventions"
          exit 1
        fi
    
    - name: Generate Pylint Reports
      if: always()
      run: |
        echo "ğŸ“„ Generating Pylint reports..."
        poetry run pylint $TARGET_DIRS --exit-zero --output-format=json > pylint-report.json || true
        echo "Pylint reports generated"
    
    - name: Upload Pylint Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pylint-reports
        path: |
          pylint-output.txt
          pylint-report.json

  # Job 3: MyPy - Type Safety
  mypy-check:
    name: ğŸ”¬ MyPy (Type Safety)
    runs-on: ubuntu-latest
    needs: pylint-check  # Chá»‰ cháº¡y khi Pylint pass
    strategy:
      matrix:
        python-version: ["3.10.6"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      id: setup-python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Install project
      run: poetry install --no-interaction
    
    - name: Set Target Directories
      run: |
        DIRS=""
        if [ -d "multi_agent" ]; then
          DIRS="$DIRS multi_agent/"
        fi
        if [ -d "server" ]; then
          DIRS="$DIRS server/"
        fi
        echo "TARGET_DIRS=$DIRS" >> $GITHUB_ENV
    
    - name: ğŸ”¬ MyPy Type Check (STRICT)
      run: |
        echo "ğŸ”¬ Running MyPy Type Check - ZERO ERRORS..."
        if poetry run mypy $TARGET_DIRS --config-file=pyproject.toml 2>&1 | tee mypy-output.txt; then
          ERROR_COUNT=$(grep -c "error:" mypy-output.txt || echo "0")
          WARNING_COUNT=$(grep -c "warning:" mypy-output.txt || echo "0")
          
          echo "ğŸ“Š MyPy Results:"
          echo "   Type Errors: $ERROR_COUNT"
          echo "   Type Warnings: $WARNING_COUNT"
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âŒ MYPY: FAILED! ($ERROR_COUNT type errors found)"
            echo "ğŸ¯ REQUIREMENT: Zero type errors allowed"
            echo "ğŸ“‹ Type errors found:"
            grep "error:" mypy-output.txt | head -10
            echo ""
            echo "ğŸ’¡ Common type fixes:"
            echo "   - Add type hints: def func(x: int) -> str:"
            echo "   - Import types: from typing import List, Dict, Optional"
            echo "   - Fix incompatible type assignments"
            exit 1
          else
            echo "âœ… MYPY: PERFECT TYPE SAFETY! ğŸ›¡ï¸"
            if [ "$WARNING_COUNT" -gt 0 ]; then
              echo "âš ï¸  Note: $WARNING_COUNT warnings found (but no errors)"
            else
              echo "ğŸ‰ Zero type issues found!"
            fi
          fi
        else
          echo "âŒ MYPY: FAILED!"
          echo "ğŸ¯ REQUIREMENT: Type checking must pass without errors"
          exit 1
        fi
    
    - name: Generate MyPy Reports
      if: always()
      run: |
        echo "ğŸ“„ Generating MyPy reports..."
        poetry run mypy $TARGET_DIRS --config-file=pyproject.toml --json-report=mypy-json-report || true
        poetry run mypy $TARGET_DIRS --config-file=pyproject.toml > mypy-text-report.txt 2>&1 || true
        echo "MyPy reports generated"
    
    - name: Upload MyPy Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mypy-reports
        path: |
          mypy-output.txt
          mypy-text-report.txt
          mypy-json-report/

  # Final Success Job
  quality-success:
    name: ğŸ‰ All Quality Checks Passed
    runs-on: ubuntu-latest
    needs: [ruff-check, pylint-check, mypy-check]  # Chá»‰ cháº¡y khi Táº¤T Cáº¢ pass
    
    steps:
    - name: ğŸ† Celebrate Perfect Code Quality
      run: |
        echo "ğŸ‰ =============================================="
        echo "ğŸ† ALL CODE QUALITY CHECKS PASSED!"
        echo "=============================================="
        echo "âœ… Ruff Format: PERFECT"
        echo "âœ… Ruff Linting: CLEAN"  
        echo "âœ… Pylint Score: 10/10"
        echo "âœ… MyPy Types: SAFE"
        echo "=============================================="
        echo "ğŸš€ Code is ready for merge! ğŸš€"
        echo "ğŸ¯ ZERO TOLERANCE QUALITY ACHIEVED!"
        echo "==============================================" 